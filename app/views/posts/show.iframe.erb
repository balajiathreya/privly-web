<html>
    <head>
        <%= javascript_include_tag :iframe %>
        <script type="text/javascript" >
            jQuery(document).ready(function(){
              
              // Update the tooltip message so that the user know they can
              // double click to edit.
              <% if can? :update, @post %>
                  updateTooltipMessage("Privly Writable (Double Click)");
              <% end %>
              
              jQuery('#post_form').bind('ajax:complete',function(evt,xhr,status){
                  jQuery("#post_content").html(jQuery.parseJSON(xhr.responseText).content);
                  iframeBehavior.resize();
              });

              jQuery("body").on("click",function(evt){
                  iframeBehavior.clickCount++;
                  if(iframeBehavior.clickCount < 2)
                  {   
                      // If the user can update the post then allow the 
                      // double click behavior (opens the edit form)
                      <% if can? :update, @post %>
                          setTimeout(function(){iframeBehavior.click(evt)},
                              300);
                      <% else %>
                          iframeBehavior.singleClick(evt);
                      <% end %>
                  }
              });
              
              
              <% if @post.public and not user_signed_in? %>
                // Public posts are easily crawlable by bots. Most bots don't
                // execute javascript, so we can protect public posts by 
                // fetching the rendered markdown after page load
              
                // This selected the content type for legacy injected iframes.
                // Future injected iframes should specify their content type with
                // a header.
                var url = document.URL;
                var jsonURL = url.replace("iframe","json");
              
                jQuery.getJSON(jsonURL, function(data) {
                  jQuery("#post_content").html(data.rendered_markdown);
                  iframeBehavior.resize();
                });
              <% end %>
            });
        </script>
        <%= stylesheet_link_tag :iframe %>
    </head>
    <body privly-exclude="true">
        <div id="wrapper">
            <div id="post_content">
                <% if not @post.public or user_signed_in? %>
                  <%= @post.content.safe_markdown %>
                <% end %>
            </div>
            <div id="post_form" style="display:none;background:none">
                <%= render 'iframe_form.html' %>
            </div>
        </div>
    </body>
</html>
